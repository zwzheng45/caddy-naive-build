name: Build caddy (naive + udpinhttp) for OpenWrt (arm64/aarch64)

on:
  workflow_dispatch:
    inputs:
      caddy_version:
        description: "可选：指定 Caddy 版本（如 v2.8.4）；留空则用 xcaddy 默认最新"
        required: false
        default: ""
  push:
    tags:
      - "caddy-naive-openwrt-build*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          check-latest: true

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      # -------------------------
      # amd64: self-check on runner
      # -------------------------
      - name: Build amd64 (naive self-check on runner)
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: "0"
        run: |
          set -eux
          mkdir -p dist
          VER="${{ inputs.caddy_version }}"
          xcaddy build ${VER:-} \
            --output dist/caddy-naive-linux-amd64 \
            --with github.com/caddyserver/forwardproxy=github.com/klzgrad/forwardproxy@naive

          ./dist/caddy-naive-linux-amd64 version
          ./dist/caddy-naive-linux-amd64 list-modules | grep -E 'http.handlers.forward_proxy|forward_proxy'

      - name: Build amd64 (udpinhttp self-check on runner)
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: "0"
        run: |
          set -eux
          mkdir -p dist
          VER="${{ inputs.caddy_version }}"
          xcaddy build ${VER:-} \
            --output dist/caddy-udpinhttp-linux-amd64 \
            --with github.com/caddyserver/forwardproxy=github.com/imgk/forwardproxy@udpinhttp

          ./dist/caddy-udpinhttp-linux-amd64 version
          ./dist/caddy-udpinhttp-linux-amd64 list-modules | grep -E 'http.handlers.forward_proxy|forward_proxy'

      # -------------------------
      # arm64: OpenWrt artifact
      # -------------------------
      - name: Build arm64 (naive artifact for OpenWrt)
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: "0"
        run: |
          set -eux
          mkdir -p dist
          VER="${{ inputs.caddy_version }}"
          xcaddy build ${VER:-} \
            --output dist/caddy-naive-linux-arm64 \
            --with github.com/caddyserver/forwardproxy=github.com/klzgrad/forwardproxy@naive

          file dist/caddy-naive-linux-arm64
          readelf -h dist/caddy-naive-linux-arm64 | grep -E 'Machine:|Class:'

      - name: Build arm64 (udpinhttp artifact for OpenWrt)
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: "0"
        run: |
          set -eux
          mkdir -p dist
          VER="${{ inputs.caddy_version }}"
          xcaddy build ${VER:-} \
            --output dist/caddy-udpinhttp-linux-arm64 \
            --with github.com/caddyserver/forwardproxy=github.com/imgk/forwardproxy@udpinhttp

          file dist/caddy-udpinhttp-linux-arm64
          readelf -h dist/caddy-udpinhttp-linux-arm64 | grep -E 'Machine:|Class:'

      # -------------------------
      # package + sha256
      # -------------------------
      - name: Package arm64 (both) + sha256
        run: |
          set -eux
          cd dist

          strip -s caddy-naive-linux-arm64 || true
          tar -czf caddy-naive-linux-arm64.tar.gz caddy-naive-linux-arm64
          sha256sum caddy-naive-linux-arm64.tar.gz > caddy-naive-linux-arm64.tar.gz.sha256

          strip -s caddy-udpinhttp-linux-arm64 || true
          tar -czf caddy-udpinhttp-linux-arm64.tar.gz caddy-udpinhttp-linux-arm64
          sha256sum caddy-udpinhttp-linux-arm64.tar.gz > caddy-udpinhttp-linux-arm64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: caddy-openwrt-arm64
          path: |
            dist/caddy-naive-linux-arm64.tar.gz
            dist/caddy-naive-linux-arm64.tar.gz.sha256
            dist/caddy-udpinhttp-linux-arm64.tar.gz
            dist/caddy-udpinhttp-linux-arm64.tar.gz.sha256

      - name: Create GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/caddy-naive-linux-arm64.tar.gz
            dist/caddy-naive-linux-arm64.tar.gz.sha256
            dist/caddy-udpinhttp-linux-arm64.tar.gz
            dist/caddy-udpinhttp-linux-arm64.tar.gz.sha256
